#Java #MyBatis/Cache
MyBatisè®¾è®¡äº†ä¸¤å±‚çš„ç¼“å­˜ï¼Œåˆ†åˆ«æ˜¯ä¸€çº§ç¼“å­˜å’ŒäºŒçº§ç¼“å­˜ï¼Œä¸‹é¢å°±æ¥åˆ†åˆ«ä»‹ç»å®ƒä»¬çš„ä½¿ç”¨å’ŒåŸç†
## ä¸€çº§ç¼“å­˜
### 1ã€åŸºæœ¬ä½¿ç”¨
#### 1.1 ä½¿ç”¨
* MyBatisä¸­é»˜è®¤æ˜¯å¼€å¯ä¸€çº§ç¼“å­˜çš„ï¼Œå› æ­¤æ— éœ€æ‰‹åŠ¨å»è·å–
* ä¸€çº§ç¼“å­˜æ˜¯åŸºäº`sqlSession`çš„ï¼Œå› æ­¤å¦‚æœè¿ç»­æŸ¥è¯¢åŒä¸€æ¡è®°å½•ï¼ŒMyBatiså°±ä¼šæŠŠè¿™æ¡è®°å½•æ”¾åˆ°ä¸€çº§ç¼“å­˜ä¸­ï¼Œä¸‹ä¸€æ¬¡æŸ¥è¯¢å°±å¯ä»¥ç›´æ¥ä»æ•°æ®åº“ä¸­è·å–ï¼›åŒæ ·åœ°ï¼Œå¦‚æœå¼€å¯äº†æ–°çš„`sqlSession`ï¼Œé‚£å³ä½¿æŸ¥è¯¢åŒä¸€æ¡è®°å½•ï¼Œä¹Ÿæ— æ³•ä½¿ç”¨åˆ°ä¸€çº§ç¼“å­˜
```ad-note 
ä¸€ä¸ªsqlSessionå¯ä»¥ç†è§£ä¸ºä¸€æ¬¡å¯¹æ•°æ®åº“çš„è¯·æ±‚
```
#### 1.2 æ¸…ç©ºä¸€çº§ç¼“å­˜
æœ‰ä»¥ä¸‹å‡ ç§æ¸…ç©ºä¸€çº§ç¼“å­˜çš„æ–¹å¼ï¼ˆæœ‰äº›æ˜¯ä¸»åŠ¨ï¼Œæœ‰äº›æ˜¯è¢«åŠ¨ï¼‰
* åœ¨`xml`æ–‡ä»¶ä¸­ä½¿ç”¨æŸ¥è¯¢è¯­å¥æ—¶ï¼ŒæŠŠ`flushCache`å±æ€§ç½®ä¸ºtrue
* å½“ä½¿ç”¨DMLè¯­å¥æ—¶ï¼ˆå³å¢åˆ æ”¹ï¼‰ï¼Œå°±ä¼šå¯¼è‡´ä¸€çº§ç¼“å­˜è¢«æ¸…ç©º
* ä½¿ç”¨`sqlSesseion#clearCache()`æ–¹æ³•æ¥æ‰‹åŠ¨æ¸…ç©º

> ä¸ºä»€ä¹ˆä½¿ç”¨DMLè¯­å¥ä¼šå¯¼è‡´ä¸€çº§ç¼“å­˜è¢«æ¸…ç©ºï¼Ÿå¾ˆç®€å•ï¼Œå› ä¸ºå½“ä½ ä½¿ç”¨DMLè¯­å¥æ—¶ï¼Œå¾€å¾€æ„å‘³ç€ä¼šä¿®æ”¹æ•°æ®åº“çš„è®°å½•ï¼Œæ‰€ä»¥MyBatisç´¢æ€§æŠŠç¼“å­˜æ¸…ç©ºæ‰ï¼Œä»¥å…å‡ºç°è„æ•°æ®

#### 1.3 æ³¨æ„ç‚¹
* ä½¿ç”¨ä¸€çº§ç¼“å­˜å›ºç„¶å¯ä»¥æé«˜æŸ¥è¯¢çš„æ€§èƒ½ï¼Œä½†åŒæ—¶éœ€è¦æ³¨æ„ï¼Œå› ä¸ºMyBatisä¼šå°†ä½ æŸ¥å‡ºæ¥çš„æ•°æ®æ”¾åˆ°ä¸€çº§ç¼“å­˜ä¸­ï¼Œä¸”å­˜æ”¾çš„æ˜¯å¯¹è±¡çš„å¼•ç”¨ï¼Œå› æ­¤å¦‚æœä½ å¯¹è¿™ä¸ªå¯¹è±¡è¿›è¡Œäº†ä¸€å®šçš„â€åŠ å·¥â€œï¼Œé‚£ä¹ˆæœ‰å¯èƒ½å¯¼è‡´ä½ ä¸‹ä¸€æ¬¡è·å–åˆ°çš„ç¼“å­˜æ•°æ®å°±éåŸå§‹æ•°æ®ï¼

***
### 2ã€è®¾è®¡ä¸åŸç†
#### 2.1ã€Cacheæ¨¡å‹
```java fold title:Cache
public interface Cache {
    // æ¯ä¸ªç¼“å­˜éƒ½æœ‰id
    String getId();
    // æ”¾ç¼“å­˜
    void putObject(Object key, Object value);
    // å–ç¼“å­˜
    Object getObject(Object key);
    // åˆ ç¼“å­˜
    Object removeObject(Object key);
    // æ¸…ç¼“å­˜
    void clear();
    // æŸ¥å¤§å°
    int getSize();
}
```
Cacheæœ¬èº«æ˜¯ä¸€ä¸ªæ¥å£ï¼Œå…·ä½“ç”±å®ƒçš„å­ç±»æ¥å®ç°
```mermaid
classDiagram
direction BT
class BlockingCache
class Cache {
<<Interface>>

}
class FifoCache
class PerpetualCache

BlockingCache  ..>  Cache 
FifoCache  ..>  Cache 
LruCache  ..>  Cache 
PerpetualCache ..> Cache

```
è¿™é‡Œæ²¡æœ‰å±•ç¤ºå…¨ï¼Œå…¶å®Cacheçš„å®ç°ç±»è¿˜æœ‰å¾ˆå¤š
è™½ç„¶Cacheçš„å®ç°ç±»å¾ˆå¤šï¼Œä½†å…¶å®åªæœ‰ä¸€ä¸ªæœ€åŸºæœ¬çš„å®ç°ç±»ï¼Œé‚£å°±æ˜¯**PerpetualCache**ï¼Œå› ä¸ºMyBatisé‡‡ç”¨çš„æ˜¯**è£…é¥°è€…æ¨¡å¼**æ¥æ„é€ ç¼“å­˜æœºåˆ¶ï¼Œå…¶ä»–ä¸åŒçš„å®ç°ç±»éƒ½æ˜¯å¯¹å®ƒçš„å¢å¼º
#### 2.2ã€è£…é¥°è€…æ¨¡å¼
å…ˆæ¥çœ‹çœ‹è¿™ä¸ªæœ€åŸºæœ¬çš„ç±»ï¼š
```java fold title:PerpetualCache
public class PerpetualCache implements Cache {

  private final String id;
  private final Map<Object, Object> cache = new HashMap<>();

//...
}
```
æ˜¯ä¸æ˜¯éå¸¸çš„æœ´å®æ— åï¼Œåªæ˜¯ç”¨äº†ä¸€ä¸ªHashMapæ¥å­˜æ”¾ç¼“å­˜çš„æ•°æ®ğŸ¶
å…·ä½“çš„å…¶ä»–åŠŸèƒ½ï¼Œæ˜¯ç”±å®ƒçš„è£…é¥°è€…æ¥å®ç°çš„ï¼Œæ¯”å¦‚æˆ‘ä»¬æƒ³å®ç°ä¸€ä¸ª**å…ˆè¿›å…ˆå‡ºçš„ç¼“å­˜ç­–ç•¥**ï¼š
```java fold title:FifoCache
public class FifoCache implements Cache {

  private final Cache delegate;
  private final Deque<Object> keyList;
  private int size;

  public FifoCache(Cache delegate) {
    this.delegate = delegate;
    this.keyList = new LinkedList<>();
    this.size = 1024;
  }
//...
}
```
```ad-note
é‡‡ç”¨è£…é¥°è€…æ¨¡å¼çš„æœ€å¤§å¥½å¤„å°±æ˜¯ï¼Œå¯ä»¥åœ¨ä¸å½±å“åŸæœ‰çš„åŠŸèƒ½æƒ…å†µä¸‹ï¼Œéšæ„çš„å¢æ·»è‡ªå·±æƒ³è¦çš„åŠŸèƒ½ï¼›
è‡³äºç¼ºç‚¹å˜›ï¼Œå¯èƒ½æ˜¯ä¼šåˆ›å»ºæ¯”è¾ƒå¤šçš„å¯¹è±¡ï¼Ÿ
```
#### 2.3ã€ä½•æ—¶ç”Ÿæ•ˆ
MyBatisæ˜¯åœ¨`BaseExecutor#query()`æ–¹æ³•æ‰§è¡Œæ—¶ï¼Œå…ˆä»ä¸€çº§ç¼“å­˜ä¸­çœ‹çœ‹æ˜¯å¦æœ‰æ•°æ®ï¼Œå¦‚æœå‘½ä¸­åˆ™è¿”å›ï¼Œå¦åˆ™å†æŸ¥è¯¢æ•°æ®åº“
```java fold title:BaseExecutor#query
public <E> List<E> query(MappedStatement ms, Object parameter, RowBounds rowBounds, 
                         ResultHandler resultHandler, CacheKey key, BoundSql boundSql) throws SQLException {
    // ......
    // å¦‚æœstatementæŒ‡å®šäº†éœ€è¦åˆ·æ–°ç¼“å­˜ï¼Œåˆ™æ¸…ç©ºä¸€çº§ç¼“å­˜
    if (queryStack == 0 && ms.isFlushCacheRequired()) {
        clearLocalCache();
    }
    List<E> list;
    try {
        queryStack++;
        // æŸ¥è¯¢ä¹‹å‰å…ˆæ£€æŸ¥ä¸€çº§ç¼“å­˜ä¸­æ˜¯å¦å­˜åœ¨æ•°æ®
        list = resultHandler == null ? (List<E>) localCache.getObject(key) : null;
        if (list != null) {
            // æœ‰ï¼Œåˆ™ç›´æ¥å–ç¼“å­˜
            handleLocallyCachedOutputParameters(ms, key, parameter, boundSql);
        } else {
            // æ²¡æœ‰ï¼Œåˆ™æŸ¥è¯¢æ•°æ®åº“
            list = queryFromDatabase(ms, parameter, rowBounds, resultHandler, key, boundSql);
        }
    } finally {
        queryStack--;
    }
    if (queryStack == 0) {
        // ......
        // å…¨å±€localCacheScopeè®¾ç½®ä¸ºstatementï¼Œåˆ™æ¸…ç©ºä¸€çº§ç¼“å­˜
        if (configuration.getLocalCacheScope() == LocalCacheScope.STATEMENT) {
            // issue #482
            clearLocalCache();
        }
    }
    return list;
}
```
å…³äºè¿™ä¸ªBaseExecutoræ˜¯å•¥ï¼Œåç»­ç”Ÿå‘½å‘¨æœŸç« èŠ‚å†å±•å¼€
## äºŒçº§ç¼“å­˜
å®é™…å¼€å‘ä¸­ï¼ŒäºŒçº§ç¼“å­˜åŸºæœ¬ä¸Šä¸ä¼šç”¨åˆ°ï¼Œæˆ‘ä»¬ä¸»è¦å­¦ä¹ å®ƒçš„è®¾è®¡æ€æƒ³
### 1ã€åŸºæœ¬ä½¿ç”¨
äºŒçº§ç¼“å­˜æ˜¯åŸºäº**namespace**çš„ï¼Œå³æˆ‘ä»¬å¹³æ—¶å†™xmlæ–‡ä»¶æ—¶å®šä¹‰çš„å‘½åç©ºé—´ï¼Œå› æ­¤å®ƒæ˜¯**è·¨sqlSession**çš„
è¦ä½¿ç”¨äºŒçº§ç¼“å­˜ä¸€å…±æœ‰ä¸¤ç§æ–¹å¼ï¼š
* åœ¨`xml`æ–‡ä»¶ä¸­ä½¿ç”¨`<cache>`æ ‡ç­¾
* åœ¨`Mapper`æ¥å£ä½¿ç”¨`@CacheNamespace`æ³¨è§£æ ‡æ³¨
å¦å¤–ï¼Œå®ä½“ç±»ä¸€å®šè¦**å®ç°Serializableæ¥å£**