#Java #MyBatis 
è¿™ç¯‡æ–‡æ¡£ä¸¥æ ¼æ¥è¯´ä¸ç®—æ˜¯MyBatisæ ¸å¿ƒæµç¨‹çš„åŠŸèƒ½ï¼Œè€Œæ˜¯MyBatisæ¡†æ¶ä¸­å®ç°çš„ä¸€äº›å·¥å…·ç±»ï¼Œä½†æ˜¯å…ˆåšä¸€äº›äº†è§£æœ‰åˆ©äºå»è¯»æ‡‚æºç ï¼Œè€Œä¸”å…¶ä¸­çš„ä¸€äº›å·¥å…·è®¾è®¡å¾—ä¹Ÿéå¸¸å·§å¦™ï¼Œå€¼å¾—å»å€Ÿé‰´å»å­¦ä¹ 
## ä¸€ã€åå°„ç›¸å…³
```ad-tip
MyBatisä¸­è·Ÿåå°„ç›¸å…³çš„APIéå¸¸ä¸°å¯Œï¼Œç”šè‡³æ¯”Springä¸­è¿˜å¤šï¼Œè€Œåå°„æ˜¯æ¡†æ¶ä¸­æœ€å¸¸ç”¨çš„APIï¼Œå¦‚æœä½ ä¹Ÿæƒ³å†™ç±»ä¼¼æ¡†æ¶çš„ç»„ä»¶ï¼Œå¤šå­¦ä¹ åå°„ç›¸å…³APIæ˜¯å¾ˆæœ‰æ„ä¹‰çš„ğŸ˜„
```
### Reflector
è¯¥ç±»å…¶å®å¯ä»¥ç®—æ˜¯ä¸€ä¸ªç”¨æ¥**å°è´¦Classä¿¡æ¯çš„å®¹å™¨**ï¼Œä¸ºä»€ä¹ˆè¿™ä¹ˆè¯´ï¼Œçœ‹çœ‹å®ƒçš„æ„é€ å°±çŸ¥é“äº†
```java fold title:Reflector
public class Reflector {

    private final Class<?> type;
    private final String[] readablePropertyNames;
    private final String[] writablePropertyNames;
    private final Map<String, Invoker> setMethods = new HashMap<>();
    private final Map<String, Invoker> getMethods = new HashMap<>();
    private final Map<String, Class<?>> setTypes = new HashMap<>();
    private final Map<String, Class<?>> getTypes = new HashMap<>();
    private Constructor<?> defaultConstructor;

```
ä¸‹é¢æ˜¯å…¶ä¸­ä¸€äº›å±æ€§çš„ä»‹ç»
* `readablePropertyNames / writeablePropertyNames`ï¼šå­˜å‚¨å¯è¯»/å¯å†™çš„å±æ€§çš„å­—æ®µçš„åå­—ï¼Œæ¯”å¦‚è¯´å¦‚æœä¸€ä¸ªBeanæ˜¯æœ‰getæ–¹æ³•ï¼Œé‚£ä¹ˆå°±è®¤ä¸ºæ˜¯å¯è¯»çš„ï¼Œè€Œå¦‚æœæ˜¯æœ‰setæ–¹æ³•ï¼Œåˆ™æ˜¯è®¤ä¸ºå¯å†™çš„ã€‚å› æ­¤ï¼Œå½“MyBatiså»è·å–/è®¾ç½®å±æ€§æ—¶ï¼Œé€šè¿‡æ–¹æ³•è·å–çš„ä¼˜å…ˆçº§æ¯”ç›´æ¥é€šè¿‡å±æ€§é«˜
* `setMethods() / getMethods()`ï¼šåŒæ ·åœ°ï¼Œç”¨æ¥å°è£…getå’Œsetæ–¹æ³•
* `setTypes() / getTypes()`ï¼šåŒç†
* `defaultConstructor`ï¼šé»˜è®¤çš„æ„é€ å™¨

### Invoker
æ³¨æ„ä¸Šé¢çš„`setMethods()`å’Œ`getMethods()` ä¸­å¯¹åº”çš„valueç±»å‹éƒ½æ˜¯`Invoker` ï¼Œå®ƒå…¶å®æ˜¯ä¸€ä¸ªæ¥å£
```java fold title:Invoker
public interface Invoker {
    Object invoke(Object target, Object[] args) throws IllegalAccessException, InvocationTargetException;
    
    Class<?> getType();
}
```
å…¶æœ‰ä»¥ä¸‹çš„å®ç°
```mermaid
classDiagram
direction BT
class AmbiguousMethodInvoker
class GetFieldInvoker
class Invoker {
<<Interface>>

}
class MethodInvoker
class SetFieldInvoker

AmbiguousMethodInvoker  -->  MethodInvoker 
GetFieldInvoker  ..>  Invoker 
MethodInvoker  ..>  Invoker 
SetFieldInvoker  ..>  Invoker 
```
é‚£ä¹ˆå®ƒçš„ä½œç”¨å¾ˆæ˜æ˜¾äº†ï¼Œå°±æ˜¯ç”¨æ¥è·å–å’Œè®¾ç½®å¯¹è±¡çš„å±æ€§ï¼Œå› ä¸ºå¹¶éæ‰€æœ‰å¯¹è±¡éƒ½æœ‰`get` æ–¹æ³•å’Œ`set` æ–¹æ³•
**å…¶å®ç»•è¿™ä¹ˆä¸€å¤§åœˆï¼ŒMyBatisä¹‹æ‰€ä»¥è¦å°è£…è¿™äº›æ–¹æ³•ã€ç±»å‹ï¼Œå…¶å®ä¸ºäº†ç¼“å­˜ï¼Œå…¸å‹çš„ç”¨ç©ºé—´æ¢æ—¶é—´**
```ad-tip
è‡³äºä¸ºä»€ä¹ˆMyBatisä¸èƒ½ç›´æ¥é€šè¿‡åå°„è°ƒ`get`å’Œ`set`æ–¹æ³•ï¼Œæˆ‘çŒœæœ‰ä»¥ä¸‹ä¸¤ç‚¹åŸå› 
* è°ƒç”¨æ–¹æ³•æ›´ç¬¦åˆè§„èŒƒï¼Œä¸”ä¸ä¼šå¯¼è‡´æƒé™å¤±æ•ˆ
* è°ƒç”¨æ–¹æ³•æ¯”ç›´æ¥è®¾ç½®å±æ€§æ•ˆç‡æ›´é«˜ï¼Ÿ
```
### PropertyTokenizer
åªçœ‹åå­—ï¼Œç¡®å®å¾ˆéš¾ç†è§£è¿™ä¸ªç±»çš„ä½œç”¨ï¼Œå› ä¸º`Tokenizer`çš„æ„æ€æ˜¯åˆ†è¯å™¨ï¼Œå®ƒçš„ä½œç”¨å…¶å®æ˜¯ä¸ºMyBatis**å¼ºå¤§çš„æ˜ å°„é…ç½®**æœåŠ¡çš„
æ¯”å¦‚è¯´ï¼Œç°åœ¨æœ‰è¿™ä¹ˆä¸ªå®ä½“ç±»ï¼š
```java
public class Model {
    private String id;
    private String name;
    private List<Entry> props;
    
    private static class Entry {
        private String key;
        private Object value;
    }
}
```
> æ•°æ®åº“ä¸­æœ‰ä¸¤åˆ—ï¼Œåˆ†åˆ«æ˜¯key1å’Œkey2

è€Œåœ¨MyBatisä¸­ï¼Œæ˜¯æ”¯æŒè¿™æ ·é…ç½®æ˜ å°„å…³ç³»çš„
```xml fold title:ModelMapper
<resultMap id=="model" class="test.Model">
    <id property="id" column="id" />
    <property name="name" column="name" />
    <property name="props[0].key" column="key1" />
    <property name="props[0].value" column="value1" />
    <property name="props[1].key" column="key2" />
    <property name="props[1].value" column="value2" />
</resultMap>
```
***
é‚£ä¹ˆMyBatisä¸­æ˜¯å¦‚ä½•å¤„ç†çš„å‘¢ï¼Ÿ
```java fold title:PropertyTokenizer
public class PropertyTokenizer implements Iterator<PropertyTokenizer> {
    private String name;
    private final String indexedName;
    private String index;
    private final String children;
	//...
}
```
**è¿™ä¸ªè®¾è®¡å…¶å®éå¸¸ç²¾å¦™ï¼Œå®ƒå®ç°äº†è¿­ä»£å™¨æ¥å£ï¼ŒåŒæ—¶è¿™ä¸ªè¿­ä»£å™¨é‡Œé¢ä¹Ÿæ˜¯å®ƒè‡ªå·±ï¼Œå¾ˆå¥½åœ°è¯ é‡Šäº†â€œå¯è¿­ä»£â€è¿™ä¸ªæ¦‚å¿µ**
å®ƒçš„ç›®çš„æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿæ¯”å¦‚ç°åœ¨æœ‰ä¸€ä¸ªè¡¨è¾¾å¼ï¼Œ`user[0].department.name` ï¼Œé‚£ä¹ˆMyBaitså°±éœ€è¦é€šè¿‡ä¸€ä¸ªUserå¯¹è±¡ï¼Œç„¶åé€šè¿‡å®ƒçš„`deparment`å±æ€§è·å–ç¬¬ä¸€ä¸ªå…ƒç´ ï¼Œå†è·å–`name`å±æ€§ï¼Œè€Œ`PropertyTokenizer`å°è£…çš„å°±æ˜¯è¿™æ ·ä¸€ä¸ª**è‡ªè¿­ä»£**çš„è¿‡ç¨‹
***
å†æ¥çœ‹çœ‹å®ƒæ˜¯å¦‚ä½•å®ç°çš„ï¼š
```java PropertyTokenizer
public class PropertyTokenizer implements Iterator<PropertyTokenizer> {
  private String name;
  private final String indexedName;
  private String index;
  private final String children;

  public PropertyTokenizer(String fullname) {
    int delim = fullname.indexOf('.');
    if (delim > -1) {
	  //è¡¨ç¤ºæœ‰å­å¯¹è±¡ï¼Œæ¯”å¦‚ç”¨æ¥åˆ†å‰²å‡ºuser[0]å’Œdepartment.name
      name = fullname.substring(0, delim);
      children = fullname.substring(delim + 1);
    } else {
      name = fullname;
      children = null;
    }
    indexedName = name;
    delim = name.indexOf('[');
    if (delim > -1) {
	  //è¡¨ç¤ºæœ‰å­é›†åˆï¼Œæ¯”å¦‚ç”¨æ¥åˆ†å‰²å‡ºuser[0]ä¸­çš„'0'å’Œ'user'
      index = name.substring(delim + 1, name.length() - 1);
      name = name.substring(0, delim);
    }
	//è¿™é‡Œè®¾ç½®å®Œåï¼Œå½“å‰å…ƒç´ çš„nameå°±æ˜¯userï¼ŒindexedNameåˆ™æ˜¯user[0]ï¼Œindexå°±æ˜¯0ï¼Œchildrenå°±æ˜¯department(ç¬¬ä¸€æ¬¡è¿­ä»£)
  }

  @Override
  public boolean hasNext() {
    return children != null;
  }

  @Override
  public PropertyTokenizer next() {
    return new PropertyTokenizer(children);
  }
```
å½“å¯¹`PropertyTokenizer`è¿­ä»£æ—¶ï¼Œå°±å¯ä»¥çº§è”è·å–å®ƒçš„å±æ€§ï¼Œæ¯”å¦‚`user -> department -> name`ï¼Œä¸”å¦‚æœè¿™ä¸ªå…ƒç´ æ˜¯é›†åˆç±»å‹çš„è¯ï¼Œå®ƒçš„indexå…ƒç´ æ ‡è¯†äº†å®ƒçš„ä¸‹æ ‡
### MetaClasss
è¯¥ç±»æ˜¯ç”¨æ¥å°è£…ç±»çš„å…ƒä¿¡æ¯ï¼Œå…¶ç»„åˆäº†`Reflector`å’Œ`PropertyTokenizer`æ¥å®ç°åŠŸèƒ½ï¼Œä»èŒè´£ä¸Šæ¥è¯´ï¼Œå®ƒä¸»è¦æ˜¯ç”¨æ¥è·å–åå°„ç±»å‹çš„ä¿¡æ¯ï¼Œæ¯”å¦‚å±æ€§å’Œæ–¹æ³•
#### findProperty
è¯¥æ–¹æ³•ç”¨æ¥çº§è”åˆ¤æ–­ä¸€ä¸ªClassä¸­æ˜¯å¦æœ‰æŒ‡å®šçš„å±æ€§
```java fold title:findProperty
public String findProperty(String name, boolean useCamelCaseMapping) {
    if (useCamelCaseMapping) {
        // å¦‚æœä½¿ç”¨äº†ä¸‹åˆ’çº¿è½¬é©¼å³°ï¼Œåˆ™è¿™ä¸ªnameè¦å»æ‰ä¸‹åˆ’çº¿(ä½†æ²¡æœ‰å°†ä¸‹åˆ’çº¿åçš„å­—æ¯æ”¹ä¸ºå¤§å†™!)
        name = name.replace("_", "");
    }
    return findProperty(name);
}

public String findProperty(String name) {
    StringBuilder prop = buildProperty(name, new StringBuilder());
    return prop.length() > 0 ? prop.toString() : null;
}
```
å¦‚æœèƒ½æ‰¾åˆ°è¯¥å±æ€§ï¼Œåˆ™è¿”å›ï¼Œå¦åˆ™è¿”å›null
```java fold title:buildProperty
private StringBuilder buildProperty(String name, StringBuilder builder) {
    // å€ŸåŠ©PropertyTokenizerè§£æ
    PropertyTokenizer prop = new PropertyTokenizer(name);
    if (prop.hasNext()) {
        String propertyName = reflector.findPropertyName(prop.getName());
        if (propertyName != null) {
            builder.append(propertyName);
            builder.append(".");
            // å¤šçº§å±æ€§ï¼Œå†newä¸€ä¸ªMetaClassç»§ç»­é€’å½’è§£æ
            MetaClass metaProp = metaClassForProperty(propertyName);
            metaProp.buildProperty(prop.getChildren(), builder);
        }
    } else {
        // å•å±‚å±æ€§ï¼Œç›´æ¥å€ŸåŠ©åå°„åˆ¤æ–­æ˜¯å¦å­˜åœ¨
        String propertyName = reflector.findPropertyName(name);
        if (propertyName != null) {
            builder.append(propertyName);
        }
    }
    return builder;
}
```
å¯ä»¥çœ‹åˆ°ï¼Œå®ƒæ˜¯é€šè¿‡åˆšæ‰çš„åˆ†è¯å™¨è¿­ä»£æ¥åˆ¤æ–­æ˜¯å¦æœ‰æŒ‡å®šå±æ€§
### MetaObject
æœ‰MetaClassè‡ªç„¶å°±æœ‰MetaObjectï¼Œå®ƒä»£è¡¨çš„æ˜¯å¯¹è±¡çš„å…ƒä¿¡æ¯ï¼Œè€Œä»èŒè´£ä¸Šæ¥è¯´ï¼Œå®ƒä¸»è¦ä¹Ÿæ˜¯ç”¨æ¥è·å–å’Œè®¾ç½®åå°„å¯¹è±¡çš„å€¼
```java fold title:MetaObject#MetaObject()
public class MetaObject {

  private final Object originalObject;
  private final ObjectWrapper objectWrapper;
  private final ObjectFactory objectFactory;
  private final ObjectWrapperFactory objectWrapperFactory;
  private final ReflectorFactory reflectorFactory;

  private MetaObject(Object object, ObjectFactory objectFactory, ObjectWrapperFactory objectWrapperFactory, ReflectorFactory reflectorFactory) {
    this.originalObject = object;
    this.objectFactory = objectFactory;
    this.objectWrapperFactory = objectWrapperFactory;
    this.reflectorFactory = reflectorFactory;

    if (object instanceof ObjectWrapper) {
      this.objectWrapper = (ObjectWrapper) object;
    } else if (objectWrapperFactory.hasWrapperFor(object)) {
      this.objectWrapper = objectWrapperFactory.getWrapperFor(this, object);
    } else if (object instanceof Map) {
      this.objectWrapper = new MapWrapper(this, (Map) object);
    } else if (object instanceof Collection) {
      this.objectWrapper = new CollectionWrapper(this, (Collection) object);
    } else {
      this.objectWrapper = new BeanWrapper(this, object);
    }
  }
```
> å…³äºè¿™ä¸ªObjectWrapperï¼Œä¸‹é¢ä¼šæåŠ
#### getValue
è¿™ä¸ªæ–¹æ³•æ˜¾ç„¶ï¼Œæ˜¯ç”¨æ¥è·å–å¯¹è±¡çš„å±æ€§å€¼ï¼Œä¸”æ”¯æŒé€’å½’è·å–
```java fold title:MetaObject#getValue()
public Object getValue(String name) {
    // å€ŸåŠ©PropertyTokenizeræ‹†åˆ†å±æ€§
    PropertyTokenizer prop = new PropertyTokenizer(name);
    if (prop.hasNext()) {
        // MetaObjecté€’å½’è·å–
        MetaObject metaValue = metaObjectForProperty(prop.getIndexedName());
        if (metaValue == SystemMetaObject.NULL_META_OBJECT) {
            return null;
        } else {
            return metaValue.getValue(prop.getChildren());
        }
    } else {
        // å•å±‚çº§å±æ€§ï¼Œç›´æ¥è°ƒç”¨ObjectWrapper
        return objectWrapper.get(prop);
    }
}
```

å€¼å¾—æ³¨æ„çš„æ˜¯ç¬¬6è¡Œä»£ç ï¼Œå®ƒä½¿ç”¨çš„æ˜¯`prop.getIndexedName()`ï¼Œå³å¸¦ç´¢å¼•çš„å±æ€§å€¼ï¼›è¿™é‡Œä¾ç„¶ä½¿ç”¨`user[0].department.name`æ¥ä¸¾ä¾‹ï¼š

### ObjectWrapper
è¿™æ˜¯ä¸€ä¸ªæ¥å£ï¼Œçœ‹åå­—å°±çŸ¥é“ï¼Œå®ƒæ˜¯é’ˆå¯¹å¯¹è±¡åšäº†ä¸€å±‚åŒ…è£…ï¼Œå…¶ä¸­æœ‰ä»¥ä¸‹æ ¸å¿ƒæ–¹æ³•ï¼š
```java fold title:ObjectWrapper
public interface ObjectWrapper {
    // æ ¹æ®æŒ‡å®šå±æ€§å–å€¼
    Object get(PropertyTokenizer prop);
    // æ ¹æ®æŒ‡å®šå±æ€§èµ‹å€¼
    void set(PropertyTokenizer prop, Object value);
    // æ£€æŸ¥å¯¹è±¡æ˜¯å¦åŒ…å«æŒ‡å®šå±æ€§
    String findProperty(String name, boolean useCamelCaseMapping);
    // æ£€æŸ¥å¯¹è±¡æ˜¯å¦åŒ…å«æŒ‡å®šå±æ€§çš„getteræ–¹æ³•
    boolean hasSetter(String name);
    // æ£€æŸ¥å¯¹è±¡æ˜¯å¦åŒ…å«æŒ‡å®šå±æ€§çš„setteræ–¹æ³•
    boolean hasGetter(String name);
    // ......
}
```
>å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œä¸Šé¢çš„get()æ–¹æ³•å’Œset()æ–¹æ³•ä¼ é€’çš„å‚æ•°éƒ½æ˜¯PropertyTokenizer

è¯¥æ¥å£æœ‰ä¸‰ä¸ªå®ç°ç±»
```mermaid fold title:ObjectWrapperç»§æ‰¿å…³ç³»
classDiagram
direction BT
class BaseWrapper
class BeanWrapper
class CollectionWrapper
class MapWrapper
class ObjectWrapper {
<<Interface>>

}

BaseWrapper  ..>  ObjectWrapper 
BeanWrapper  -->  BaseWrapper 
CollectionWrapper  ..>  ObjectWrapper 
MapWrapper  -->  BaseWrapper 

```
é€šè¿‡åå­—å°±å¯ä»¥çœ‹å‡ºï¼Œå®ƒä»¬çš„åŒºåˆ«æ˜¯å¯¹ä¸åŒçš„ç±»å‹è¿›è¡Œäº†åŒ…è£…ï¼Œä¸‹é¢æ¥çœ‹ä¸€ä¸ªå®ç°ç±»
#### BeanWrapper

			